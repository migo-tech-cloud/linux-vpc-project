#!/usr/bin/env python3
import subprocess
import sys

# Hardcoded VPCs
VPCS = ["Migo-vpc-1", "Migo-vpc-2"]
HOST_IF = "enX0"

def run(cmd):
    """Run a shell command and print output."""
    print(f"üîπ Running: {cmd}")
    subprocess.run(cmd, shell=True, check=False)

def create_vpcs():
    print("üöÄ Creating Migo-vpc-1 and Migo-vpc-2...\n")
    for vpc in VPCS:
        run(f"bash ./scripts/create_{vpc.lower().replace('-', '_')}.sh {vpc} {HOST_IF}")
        print(f"‚úÖ VPC {vpc} created successfully!\n")

def delete_vpcs():
    print("üßπ Deleting Migo-vpc-1 and Migo-vpc-2...\n")
    for vpc in VPCS:
        run(f"bash ./scripts/delete_{vpc.lower().replace('-', '_')}.sh {vpc}")
        print(f"‚úÖ VPC {vpc} deleted successfully!\n")

def start_server(namespace="Migo-vpc-1-public", port=80):
    run(f"ip netns exec {namespace} python3 -m http.server {port} &")
    print(f"‚úÖ HTTP server started in namespace {namespace} on port {port}")

def stop_server():
    run("pkill -f 'python3 -m http.server'")
    print("‚úÖ All HTTP servers stopped")

def usage():
    print("""
Usage: python3 vpcctl.py <command> [options]

Commands:
  create             Create all hardcoded VPCs
  delete             Delete all VPCs and cleanup
  start-server       Start HTTP server in a namespace (default Migo-vpc-1-public, port 80)
  stop-server        Stop all HTTP servers
  help               Show this help
""")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        usage()
        sys.exit(1)
    
    cmd = sys.argv[1].lower()

    if cmd == "create":
        create_vpcs()
    elif cmd == "delete":
        delete_vpcs()
    elif cmd == "start-server":
        ns = sys.argv[2] if len(sys.argv) > 2 else "Migo-vpc-1-public"
        port = sys.argv[3] if len(sys.argv) > 3 else 80
        start_server(ns, port)
    elif cmd == "stop-server":
        stop_server()
    elif cmd == "help":
        usage()
    else:
        print("‚ùå Unknown command")
        usage()




