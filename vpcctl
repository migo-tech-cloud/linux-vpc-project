#!/usr/bin/env python3
import subprocess
import sys
import logging

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s | %(levelname)s | %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S",
)

# Hardcoded VPCs
VPCS = [
    {"name": "Migo-vpc-1", "script": "scripts/create_vpc_1.sh"},
    {"name": "Migo-vpc-2", "script": "scripts/create_vpc_2.sh"},
]

HOST_INTERFACE = "enX0"  # Replace with actual host interface

def run_command(cmd):
    logging.info(f"üîπ Running command: {cmd}")
    try:
        subprocess.run(cmd, shell=True, check=True)
    except subprocess.CalledProcessError as e:
        logging.error(f"‚ùå Command failed with exit code {e.returncode}")

def create_vpcs():
    logging.info("üöÄ Starting VPC creation process...")
    for vpc in VPCS:
        logging.info(f"Creating {vpc['name']} using {vpc['script']}")
        run_command(f"bash {vpc['script']} {vpc['name']} {HOST_INTERFACE}")
    logging.info("‚úÖ All VPCs created successfully!")

def delete_vpcs():
    logging.info("üßπ Cleaning up all VPCs...")
    for vpc in VPCS:
        logging.info(f"üîπ Deleting VPC: {vpc['name']}")
        # Remove namespaces
        for ns_type in ["public", "private"]:
            ns = f"{vpc['name']}-{ns_type}"
            run_command(f"sudo ip netns delete {ns}")
        # Remove bridge
        br = f"{vpc['name']}-br0"
        run_command(f"sudo ip link set {br} down")
        run_command(f"sudo ip link delete {br} type bridge")
    # Flush NAT rules
    run_command(f"sudo iptables -t nat -F")
    logging.info("‚úÖ Cleanup completed. All VPCs removed.")

def start_server():
    ns = f"{VPCS[0]['name']}-public"
    logging.info(f"Starting HTTP server in namespace {ns} on port 80")
    run_command(f"sudo ip netns exec {ns} python3 -m http.server 80 &")

def stop_server():
    logging.info("Stopping all HTTP servers")
    run_command("pkill -f 'python3 -m http.server' || true")

def print_help():
    print("""
Usage: python3 vpcctl.py <command> [options]

Commands:
  create       Create all hardcoded VPCs
  delete       Delete all VPCs and cleanup
  start-server Start HTTP server in first public subnet (port 80)
  stop-server  Stop all HTTP servers
  help         Show this help
""")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print_help()
        sys.exit(1)

    cmd = sys.argv[1].lower()

    if cmd == "create":
        create_vpcs()
    elif cmd == "delete":
        delete_vpcs()
    elif cmd == "start-server":
        start_server()
    elif cmd == "stop-server":
        stop_server()
    elif cmd == "help":
        print_help()
    else:
        logging.error(f"Unknown command: {cmd}")
        print_help()











