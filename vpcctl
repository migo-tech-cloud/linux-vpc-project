#!/usr/bin/env python3
import os
import sys
import subprocess
import datetime
import logging

# -----------------------------------------------------------------------------
# CONFIGURATION
# -----------------------------------------------------------------------------
LOG_DIR = "logs"
LOG_FILE = os.path.join(LOG_DIR, "vpcctl.log")
VPCS = [
    {"name": "Migo-vpc-1", "script": "scripts/create_vpc1.sh"},
    {"name": "Migo-vpc-2", "script": "scripts/create_vpc2.sh"},
]
HOST_INTERFACE = "enX0"

# -----------------------------------------------------------------------------
# LOGGING SETUP
# -----------------------------------------------------------------------------
def setup_logging():
    os.makedirs(LOG_DIR, exist_ok=True)
    logger = logging.getLogger("vpcctl")
    logger.setLevel(logging.INFO)

    # Formatter
    formatter = logging.Formatter("%(asctime)s | %(levelname)s | %(message)s")

    # File handler
    fh = logging.FileHandler(LOG_FILE)
    fh.setFormatter(formatter)
    logger.addHandler(fh)

    # Console handler
    ch = logging.StreamHandler(sys.stdout)
    ch.setFormatter(formatter)
    logger.addHandler(ch)

    return logger


logger = setup_logging()

# -----------------------------------------------------------------------------
# HELPER: Run shell commands with live output
# -----------------------------------------------------------------------------
def run_command(command, cwd=None):
    logger.info(f"üîπ Running command: {command}")
    process = subprocess.Popen(
        command, shell=True, cwd=cwd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True
    )
    for line in process.stdout:
        logger.info(line.strip())
    process.wait()
    if process.returncode == 0:
        logger.info("‚úÖ Command completed successfully.")
    else:
        logger.error(f"‚ùå Command failed with exit code {process.returncode}")
    return process.returncode

# -----------------------------------------------------------------------------
# CORE COMMANDS
# -----------------------------------------------------------------------------
def create_vpcs():
    logger.info("üöÄ Starting VPC creation process...")
    for vpc in VPCS:
        logger.info(f"Creating {vpc['name']} using {vpc['script']}")
        run_command(f"bash {vpc['script']} {vpc['name']} {HOST_INTERFACE}")
    logger.info("‚úÖ All VPCs created successfully!\n")

def delete_vpcs():
    logger.info("üßπ Cleaning up all VPCs...")
    run_command("bash scripts/delete_vpcs.sh")
    logger.info("‚úÖ Cleanup completed.\n")

def start_server():
    logger.info("üöÄ Starting HTTP server inside Migo-vpc-1-public namespace...")
    run_command("bash scripts/start_server.sh")
    logger.info("‚úÖ Server started.\n")

def stop_server():
    logger.info("üõë Stopping all HTTP servers...")
    run_command("bash scripts/stop_server.sh")
    logger.info("‚úÖ All servers stopped.\n")

def show_help():
    print("""
Usage: python3 vpcctl.py <command> [options]

Commands:
  create             Create all hardcoded VPCs (Migo-vpc-1 and Migo-vpc-2)
  delete             Delete all VPCs and cleanup
  start-server       Start HTTP server in Migo-vpc-1-public namespace
  stop-server        Stop all HTTP servers
  help               Show this help

Examples:
  python3 vpcctl.py create | tee -a logs/vpcctl.log
  python3 vpcctl.py delete
""")

# -----------------------------------------------------------------------------
# MAIN ENTRY
# -----------------------------------------------------------------------------
if __name__ == "__main__":
    if len(sys.argv) < 2:
        show_help()
        sys.exit(1)

    command = sys.argv[1].lower()

    if command == "create":
        create_vpcs()
    elif command == "delete":
        delete_vpcs()
    elif command == "start-server":
        start_server()
    elif command == "stop-server":
        stop_server()
    elif command == "help":
        show_help()
    else:
        print(f"‚ùå Unknown command: {command}")
        show_help()









